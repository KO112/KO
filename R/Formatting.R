# Include other functions in package
#' @include Pipes.R
#' @include Error_Handling.R
NULL

# Avoid "undefined variable" notes in package checking
globalVariables(c("."))


#' Format a numerical vector as percents
#'
#' Format a numerical vector as a character vector holding the values formatted as percents.
#' Will throw an error for non-numeric vetcors, and  print a message if NA values are found.
#'
#' @param vec Vector to format as a percent
#' @param accuracy The number to round to the nearest multiple of
#'   (e.g 3.14159 will round to 314.16% by default).
#'   The absolutely value of the value passed will be used.
#'   The rounding will be done after conversion to a percent.
#' @param vecNames Vector used to name the output
#' @param silent If TRUE, will not print out a message if NA values are found
#'
#' @return Character vector of items formatted as percent.
#' @export
#'
#' @examples
#' format_percent(0.12345)
#' format_percent(pi)
#' format_percent(0.1)
#' format_percent(0.12345, accuracy = 0.1)
#' format_percent(c(0.12345, 0.54321), vecNames = c("a", "b"))
#'
format_percent <- function(vec, accuracy = 0.01, vecNames = names(vec), silent = FALSE) {
  stop_if(!is.numeric(vec), "Non-numeric vector passed.")
  if (any(is.na(vec)) & !silent) message("NA values were found, and will be printed as \"NA%\"")
  scales::percent(x = vec, accuracy = abs(accuracy)) %>%
    stats::setNames(vecNames) %>%
    return()
}


#' Format a data frame in LaTeX code
#'
#' Format a data frame to print out as a LaTeX table with side borders.
#'
#' @param data Data frame to be formatted into a LaTeX table
#'
#' @return String to use used for printing a table in LaTeX.
#' @export
#'
#' @examples
#' latex_table(mtcars)
#'
latex_table <- function(data) {
  knitr::kable(x = data, format = "latex") %>%
    gsub("\\{([rcl\\|]+)\\}", "\\{|\\1|\\}", .) %>%
    as.character() %>%
    return()
}




#' Convert a vector to a padded character column
#'
#' @param vec Vector to pad values of
#' @param header Optional name of vector to add to top of return value
#' @param padWith Character to pad output vector with
#' @param alignment Alignment of text in output (one of 'R', 'L', 'C')
#'
#' @return A character vector padded with spaces to give uniform width.
#' @export
#'
#' @examples
#' pad_vector(c(1, 2, 300))
#' pad_vector(c(1, 2), header = "Header")
#' pad_vector(c(1, 2, 300), padWith = "_")
#' pad_vector(c(1, 200, 3), alignment = "L")
#' pad_vector(c(100, 2, 30), alignment = "C")
#'
pad_vector <- function(vec, header = NA, padWith = " ", alignment = "R") {

  # If a header was passed, add it as fhe first element
  if (!is.na(header)) vec <- c(header, vec)

  # Convert the vector to character, count the number of characters in each element,
  #   find the maximum width, and create a vector holding the padding
  width <- as.character(vec) %>% nchar()
  maxWidth <- max(width)
  paddedVec <- strrep(padWith, maxWidth - width)

  # Pad the vector, aligning the values to either the left, center, or right
  if (alignment == "L") {
    paddedVec %<>% paste0(vec, .)
  } else if (alignment == "C") {
    paddedVec <- strrep(padWith, maxWidth - width) %>% paste0(vec)
    paddedVec <- paste0(strrep(padWith, floor((maxWidth - width) / 2)),
                        vec,
                        strrep(padWith, ceiling((maxWidth - width) / 2)))
  } else {
    if (alignment != "R") message("Invalid alignment option chosen. Defaulting to \"R\".")
    paddedVec %<>% paste0(., vec)
  }

  # If a header was passed, add a row of dashes between it and the rest of the vector
  if (!is.na(header)) return(paddedVec %>% {c(.[1], strrep("-", maxWidth), .[-1])})
  return(paddedVec)

}


#' Returns a data frame in plain text with padded (equal width) columns
#'
#' @param data A data frame to convert to plain text
#' @param sep Characters to bs used as column seperators
#' @param catOut Whether or not to print the value to standard output
#'
#' @return If catOut, nothing, else a string containing the table in plain text form.
#' @export
#'
#' @examples
#' plain_text_table(head(mtcars))
#' plain_text_table(head(cars))
#' plain_text_table(data.frame(a = 1:2, b = 3:4))
#' plain_text_table(head(mtcars), sep = "+")
#' plain_text_table(head(mtcars), catOut = FALSE)
#'
plain_text_table <- function(data, sep = " | ", catOut = TRUE) {
  plainTextTbl <- mapply(pad_vector, vec = data, header = names(data)) %>%
    apply(1, paste0, collapse = sep) %>%
    paste0(collapse = "\n")
  if (catOut) cat(plainTextTbl)
  else return(plainTextTbl)
}
